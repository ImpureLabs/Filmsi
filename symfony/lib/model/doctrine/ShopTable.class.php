<?php

/**
 * ShopTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ShopTable extends Doctrine_Table
{
	/**
	 * @return ShopTable
	 */
	public static function getInstance()
	{
		return Doctrine_Core::getTable('Shop');
	}

	public function getAllDetailed()
	{
		return Doctrine_Query::create()
			->select('s.*, COUNT(f.id) film_counter')
			->from('Shop s')
			->groupBy('s.id, f.id')
			->leftJoin('s.Films f')
			->execute(array(), Doctrine_Core::HYDRATE_ARRAY);
	}

	public function getFormattedByFilm($filmId)
	{
		$bruteShops =  Doctrine_Query::create()
			->from('Shop s')
			->innerJoin('s.ShopFilm sf')
			->where('sf.film_id = ?', $filmId)
			->orderBy('s.name ASC')
			->execute(array(), Doctrine_Core::HYDRATE_SCALAR);

		$shops = array(
			'dvd' => array(),
			'bluray' => array(),
			'online' => array()
		);

		foreach ($bruteShops as $bruteShop){
			$shops[$bruteShop['sf_format']][] = array(
				'id' => $bruteShop['s_id'],
				'name' => $bruteShop['s_name'],
				'email' => $bruteShop['s_email'],
				'phone' => $bruteShop['s_phone'],
				'url' => $bruteShop['s_url'],
				'filename' => $bruteShop['s_filename'],
				'description' => $bruteShop['s_description'],
				'film_url' => $bruteShop['sf_url'],
			);
		}

		return $shops;
	}

	public function getByFilm($filmId)
	{
		return  Doctrine_Query::create()
			->from('Shop s')
			->innerJoin('s.ShopFilm sf')
			->where('sf.film_id = ?', $filmId)
			->orderBy('s.name ASC')
			->groupBy('sf.shop_id')
			->execute(array(), Doctrine_Core::HYDRATE_ARRAY);
	}

	public function getForGadget($limit)
	{
		return Doctrine_Query::create()
			->from('Shop s')
			->orderBy('RAND()')
			->limit($limit)
			->execute();
	}
}