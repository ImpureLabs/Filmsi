<?php

/**
 * PersonTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class PersonTable extends Doctrine_Table
{
	public function allow($libraryId)
	{
		$album = Doctrine_Core::getTable('Person')->findOneByLibraryId($libraryId);
		
		/* Update album state*/
		$album->setState(Library::STATE_ACTIVE);
		$album->save();
	}

	public function cloneObject($libraryId)
	{
		$person = Doctrine_Core::getTable('Person')->findOneByLibraryId($libraryId);
		
		/* Cloning the object */
		$newPerson = new Person();
		$newPerson->setFirstName($person->getFirstName());
		$newPerson->setLastName($person->getLastName() . ' - clone');
		$newPerson->setDateOfBirth($person->getDateOfBirth());
		$newPerson->setDateOfDeath($person->getDateOfDeath());
		$newPerson->setPlaceOfBirth($person->getPlaceOfBirth());
		$newPerson->setFilename($person->getFilename());
		$newPerson->setBiographyTeaser($person->getBiographyTeaser());
		$newPerson->setBiographyContent($person->getBiographyContent());
		$newPerson->setState($person->getState());
		$newPerson->setImdb($person->getImdb());
		$newPerson->setIsActor($person->getIsActor());
		$newPerson->setIsDirector($person->getIsDirector());
		$newPerson->setIsScriptwriter($person->getIsScriptwriter());
		$newPerson->setIsProducer($person->getIsProducer());
		$newPerson->setPublishDate($person->getPublishDate());
		$newPerson->setUserId(sfContext::getInstance()->getUser()->getGuardUser()->getId());
		
		
		$pieces = explode('.', $person->getFilename());
		$extension = $pieces[1];
		$newFilename = md5(time() . rand(0, 999999)) . '.' . $extension;
			
		/* Copying the photo files */
		copy(sfConfig::get('app_person_path') . '/' . $person->getFilename(), sfConfig::get('app_person_path') . '/' . $newFilename);
		copy(sfConfig::get('app_person_path') . '/t-' . $person->getFilename(), sfConfig::get('app_person_path') . '/t-' . $newFilename);
		copy(sfConfig::get('app_person_path') . '/ts-' . $person->getFilename(), sfConfig::get('app_person_path') . '/ts-' . $newFilename);
		
		$newPerson->setFilename($newFilename);
		$newPerson->save();
	}

	public function getForApi($term)
	{
		$term = '(^| |-)' . $term ;
		
		$brutePersons = Doctrine_Query::create()
			->from('Person p')
			->andWhere('p.state = 1')
			->andWhere('p.first_name REGEXP ? OR p.last_name REGEXP ?', array($term, $term))
			->orderBy('p.last_name ASC')
			->limit(50)
			->execute();

		$persons = array();
		foreach ($brutePersons as $key => $brutePerson){
			$persons[$key]['value'] = $brutePerson->getId();
			$persons[$key]['label'] = $brutePerson->getName();
		}
		
		return $persons;
	}

	public function getForApiImdb($term)
	{
		$term = '(^| |-)' . $term ;

		$brutePersons = Doctrine_Query::create()
			->from('Person p')
			->andWhere('p.state = 1')
			->andWhere('p.first_name REGEXP ? OR p.last_name REGEXP ?', array($term, $term))
			->orderBy('p.last_name ASC')
			->limit(50)
			->execute();

		$persons = array();
		foreach ($brutePersons as $key => $brutePerson){
			$persons[$key]['value'] = $brutePerson->getImdb();
			$persons[$key]['label'] = $brutePerson->getName();
		}

		return $persons;
	}
}